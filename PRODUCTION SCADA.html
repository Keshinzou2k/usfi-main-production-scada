<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Production Control Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #1a2a3a;
    --secondary: #2c3e50;
    --accent: #3498db;
    --success: #2ecc71;
    --warning: #f39c12;
    --danger: #e74c3c;
    --light: #ecf0f1;
    --dark: #2c3e50;
    --gray: #95a5a6;
    --dark-gray: #34495e;
    --standby: #95a5a6;
    --dispensing: #2ecc71;
    --calibrating: #f39c12;
    --dropping: #9b59b6;
    --done: #3498db;
    --offline: #e74c3c;
    
    /* Theme variables */
    --bg-primary: #1a2a3a;
    --bg-secondary: #2c3e50;
    --bg-card: rgba(26, 42, 58, 0.8);
    --text-primary: #ecf0f1;
    --text-secondary: #bdc3c7;
    --border-color: rgba(255, 255, 255, 0.05);
  }

  /* Light theme */
  .theme-light {
    --bg-primary: #f5f5f5;
    --bg-secondary: #e0e0e0;
    --bg-card: rgba(255, 255, 255, 0.9);
    --text-primary: #2c3e50;
    --text-secondary: #7f8c8d;
    --border-color: rgba(0, 0, 0, 0.1);
  }

  /* Traditional theme */
  .theme-traditional {
    --bg-primary: #8B4513;
    --bg-secondary: #A0522D;
    --bg-card: rgba(139, 69, 19, 0.9);
    --text-primary: #F5DEB3;
    --text-secondary: #DEB887;
    --border-color: rgba(245, 222, 179, 0.2);
  }

  /* Soft theme */
  .theme-soft {
    --bg-primary: #FAD9D7;
    --bg-secondary: #FAEBD7;
    --bg-card: rgba(248, 250, 215, 0.9);
    --text-primary: #2c3e50;
    --text-secondary: #7f8c8d;
    --border-color: rgba(44, 62, 80, 0.1);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
    margin: 0;
    padding: 20px;
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
    transition: all 0.3s ease;
  }

  .container {
    width: 100%;
    max-width: none;
    margin: 0 auto;
  }

  h2 {
    text-align: center;
    margin-bottom: 15px;
    color: var(--text-primary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 1.2rem;
    position: relative;
    padding-bottom: 10px;
  }

  h2::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--success));
    border-radius: 2px;
  }

  .dashboard {
    display: grid;
    grid-template-columns: 1fr 2fr;
    grid-gap: 25px;
    width: 100%;
  }

  .card {
    padding: 20px;
    border-radius: 16px;
    background: var(--bg-card);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    transition: transform 0.3s, box-shadow 0.3s;
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
  }

  /* Top Header */
  .header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 25px;
    gap: 15px;
    width: 100%;
  }

  .header .box {
    flex: 1;
    text-align: center;
    padding: 18px;
    border-radius: 12px;
    font-weight: bold;
    background: var(--bg-card);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .header .box:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
  }

  .header .box::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
  }

  .header .box:nth-child(1) {
    background: rgba(52, 152, 219, 0.15);
  }

  .header .box:nth-child(2) {
    background: rgba(46, 204, 113, 0.15);
  }

  .header .box:nth-child(3) {
    background: rgba(155, 89, 182, 0.15);
  }

  .header .box:nth-child(4) {
    background: rgba(243, 156, 18, 0.15);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* Settings button */
  .settings-btn {
    background: rgba(52, 152, 219, 0.15);
    border: none;
    color: var(--text-primary);
    padding: 22px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s;
  }

  .settings-btn:hover {
    background: rgba(52, 152, 219, 0.3);
  }

  .settings-dropdown {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    background: var(--bg-card);
    min-width: 200px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    z-index: 1;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border-color);
  }

  .settings-dropdown a {
    color: var(--text-primary);
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    transition: background 0.3s;
  }

  .settings-dropdown a:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .settings-container {
    position: relative;
    display: inline-block;
  }

  .settings-container:hover .settings-dropdown {
    display: block;
  }

  /* Status indicator in header */
  .status-indicator {
    display: inline-flex;
    align-items: center;
    margin-left: 10px;
  }

  .status-text {
    font-weight: bold;
    font-size: 1.1rem;
    transition: all 0.3s ease;
  }

  .status-standby { color: var(--standby); }
  .status-dispensing { color: var(--dispensing); }
  .status-calibrating { color: var(--calibrating); }
  .status-dropping { color: var(--dropping); }
  .status-done { color: var(--done); }
  .status-offline { color: var(--offline); }

  /* Mixers */
  .mixers {
    display: flex;
    justify-content: space-around;
    margin-bottom: 20px;
    gap: 15px;
  }

  .mixer {
    flex: 1;
    padding: 20px 10px;
    text-align: center;
    border-radius: 12px;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: #fff;
    font-weight: bold;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }

  .mixer::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
  }

  .mixer:hover::before {
    left: 100%;
  }

  .mixer:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
  }

  .mixer.active {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
  }

  .mixer.offline {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    cursor: not-allowed;
  }

  .mixer.disabled {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    cursor: not-allowed;
    opacity: 0.6;
  }

  .mixer-number {
    font-size: 2.5rem;
    font-weight: 800;
    display: block;
    line-height: 1;
    margin-bottom: 5px;
    transition: all 0.3s ease;
  }

  .mixer-label {
    font-size: 0.9rem;
    opacity: 0.9;
    display: block;
    transition: all 0.3s ease;
  }

  .mixer:hover .mixer-number {
    transform: scale(1.1);
  }

  .mixer:hover .mixer-label {
    transform: scale(0.95);
  }

  /* Mixer tooltip for assigned recipe */
  .mixer-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px;
    border-radius: 5px;
    white-space: nowrap;
    z-index: 10;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    pointer-events: none;
  }

  .mixer:hover .mixer-tooltip {
    opacity: 1;
    visibility: visible;
  }

  /* Timer + Production Info */
  .info-box {
    text-align: center;
    margin-bottom: 20px;
    padding: 25px;
    border-radius: 16px;
    background: var(--bg-card);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
  }

  .info-box::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(90deg, #3498db, #2ecc71, #e74c3c, #f39c12);
    background-size: 400% 100%;
    animation: gradientShift 3s ease infinite;
  }

  .info-box span {
    display: block;
    margin: 10px 0;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .timer-container {
    margin: 20px 0;
    padding: 20px;
    border-radius: 12px;
    background: rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
  }

  .timer {
    font-size: 5rem;
    font-weight: 800;
    color: #2ecc71;
    text-shadow: 0 0 5px rgba(46, 204, 113, 0.5);
    margin: 15px 0;
    font-family: 'Courier New', monospace;
    letter-spacing: 3px;
    position: relative;
    z-index: 2;
    transition: all 0.3s ease;
    opacity: 0;
  }

  .timer.show {
    opacity: 1;
  }

  .timer.hide {
    opacity: 0;
  }

  .timer-label {
    font-size: 1.2rem;
    color: var(--text-primary);
    margin-top: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .progress-bar {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    margin: 15px 0;
    overflow: hidden;
  }

  .progress {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--success));
    border-radius: 4px;
    width: 0%;
    transition: width 0.5s;
  }

  /* Previous Item Box */
  .prev-item-box {
    text-align: center;
    margin-bottom: 20px;
    padding: 15px;
    border-radius: 12px;
    background: var(--bg-card);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    transition: all 0.3s;
    cursor: pointer;
    display: none;
  }

  .prev-item-box:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
  }

  .prev-item-box.active {
    display: block;
    animation: fadeIn 0.5s;
  }

  .prev-item-title {
    font-weight: bold;
    margin-bottom: 10px;
    color: var(--accent);
  }

  .prev-item-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    text-align: left;
  }

  .prev-item-detail {
    font-size: 0.9rem;
  }

  .prev-item-detail span {
    font-weight: bold;
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  table th, table td {
    padding: 12px 8px;
    text-align: center;
    border-bottom: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }

  table th {
    background: rgba(52, 73, 94, 0.7);
    font-weight: 600;
    color: var(--text-primary);
    position: sticky;
    top: 0;
  }

  table tr {
    transition: all 0.5s ease;
    opacity: 1;
    transform: scale(1);
  }

  table tr.hidden {
    opacity: 0;
    transform: scale(0.95);
    height: 0;
    padding: 0;
    margin: 0;
    display: none;
  }

  table tr.restoring {
    opacity: 0;
    transform: scale(0.95);
  }

  table tr:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  table tr:hover td {
    transform: translateX(5px);
  }

  /* Status indicators in table */
  .status {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 5px;
  }

  .status.standby {
    background-color: var(--standby);
  }

  .status.dispensing {
    background-color: var(--dispensing);
  }

  .status.calibrating {
    background-color: var(--calibrating);
  }

  .status.dropping {
    background-color: var(--dropping);
  }

  .status.done {
    background-color: var(--done);
  }

  .status.offline {
    background-color: var(--offline);
  }

  /* Weight stability indicator */
  .stability {
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 3px;
  }

  .stability.st {
    color: #2ecc71;
    text-shadow: 0 0 5px rgba(46, 204, 113, 0.7);
    animation: glow-green 2s infinite;
  }

  .stability.un {
    color: #e74c3c;
    text-shadow: 0 0 5px rgba(231, 76, 60, 0.7);
    animation: glow-red 2s infinite;
  }

  /* Formula and Pending Production Side by Side */
  .formula-pending-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    grid-gap: 20px;
    margin-bottom: 20px;
  }

  .formula-section {
    height: auto;
    max-height: none;
  }

  .pending-section {
    height: auto;
  }

  /* Scrollable sections */
  .scrollable {
    max-height: none;
    overflow-y: visible;
  }

  /* Controls */
  .controls {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    grid-gap: 15px;
    margin-top: 20px;
  }

  .btn {
    padding: 15px;
    text-align: center;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
  }

  .btn:hover::before {
    left: 100%;
  }

  .btn.green {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: #fff;
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
  }

  .btn.red {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: #fff;
    box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
  }

  .btn.blue {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: #fff;
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
  }

  .btn.yellow {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: #fff;
    box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
  }

  .btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
  }

  .btn:active {
    transform: translateY(1px);
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s;
  }

  .modal-content {
    background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
    width: 90%;
    max-width: 600px;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    animation: slideUp 0.4s;
    border: 1px solid var(--border-color);
  }

  .modal-header {
    padding: 20px;
    background: rgba(52, 73, 94, 0.9);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    margin: 0;
    color: var(--text-primary);
  }

  .close-modal {
    background: none;
    border: none;
    color: var(--text-primary);
    font-size: 1.5rem;
    cursor: pointer;
    transition: color 0.3s;
  }

  .close-modal:hover {
    color: var(--danger);
    transform: scale(1.1);
  }

  .modal-body {
    padding: 30px;
    text-align: center;
    max-height: 80vh;
    overflow-y: auto;
  }

  .modal-text {
    font-size: 1.2rem;
    margin-bottom: 30px;
    line-height: 1.5;
  }

  .modal-controls {
    display: flex;
    justify-content: center;
    gap: 20px;
  }

  .modal-btn {
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    border: none;
    font-size: 1rem;
    transition: all 0.3s;
  }

  .modal-btn.confirm {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: white;
  }

  .modal-btn.cancel {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
  }

  .modal-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  }

  .modal.active {
    display: flex;
  }

  /* Theme selector in modal */
  .theme-options {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin: 20px 0;
  }

  .theme-option {
    padding: 15px;
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s;
    border: 2px solid transparent;
  }

  .theme-option:hover {
    transform: scale(1.05);
  }

  .theme-option.active {
    border-color: var(--accent);
  }

  .theme-dark {
    background: linear-gradient(135deg, #1a2a3a, #2c3e50);
    color: white;
  }

  .theme-light {
    background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
    color: #2c3e50;
  }

  .theme-traditional {
    background: linear-gradient(135deg, #8B4513, #A0522D);
    color: #F5DEB3;
  }

  .theme-soft {
    background: linear-gradient(135deg, #FAD9D7, #FAEBD7);
    color: #2c3e50;
  }

  /* Maintenance request form */
  .form-group {
    margin-bottom: 15px;
    text-align: left;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }

  .form-group select, .form-group input {
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid var(--border-color);
    background: var(--bg-card);
    color: var(--text-primary);
  }

  .form-group.checkbox {
    display: flex;
    align-items: center;
  }

  .form-group.checkbox input {
    width: auto;
    margin-right: 10px;
  }

  .request-sentence {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 5px;
    margin: 20px 0;
    font-style: italic;
  }

  /* Dispensing details in completion modal */
  .dispensing-details {
    text-align: left;
    margin: 20px 0;
  }

  .detail-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px dashed var(--border-color);
  }

  .detail-label {
    font-weight: bold;
  }

  .detail-value {
    text-align: right;
  }

  .weight-difference {
    font-weight: bold;
    margin-top: 10px;
    padding: 10px;
    border-radius: 5px;
    text-align: center;
  }

  .weight-difference.positive {
    background: rgba(46, 204, 113, 0.2);
    color: var(--success);
  }

  .weight-difference.negative {
    background: rgba(231, 76, 60, 0.2);
    color: var(--danger);
  }

  .weight-difference.exact {
    background: rgba(52, 152, 219, 0.2);
    color: var(--accent);
  }

  /* Previous production details table */
  .prev-production-table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
  }

  .prev-production-table th {
    background: rgba(52, 73, 94, 0.7);
    padding: 10px;
    text-align: center;
  }

  .prev-production-table td {
    padding: 8px;
    text-align: center;
    border-bottom: 1px solid var(--border-color);
  }

  /* Fault Panel */
  .fault-panel {
    background: rgba(231, 76, 60, 0.1);
    border: 1px solid rgba(231, 76, 60, 0.3);
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    display: none;
  }

  .fault-panel.active {
    display: block;
    animation: fadeIn 0.5s;
  }

  .fault-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
  }

  .fault-item:last-child {
    border-bottom: none;
  }

  .fault-severity {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
  }

  .fault-minor {
    background: rgba(243, 156, 18, 0.2);
    color: var(--warning);
  }

  .fault-major {
    background: rgba(231, 76, 60, 0.2);
    color: var(--danger);
  }

  .fault-critical {
    background: rgba(192, 57, 43, 0.3);
    color: #ffcccc;
  }

  /* Animations */
  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
    }
  }

  @keyframes glow-green {
    0%, 100% {
      text-shadow: 0 0 5px rgba(46, 204, 113, 0.7);
    }
    50% {
      text-shadow: 0 0 15px rgba(46, 204, 113, 1), 0 0 20px rgba(46, 204, 113, 0.7);
    }
  }

  @keyframes glow-red {
    0%, 100% {
      text-shadow: 0 0 5px rgba(231, 76, 60, 0.7);
    }
    50% {
      text-shadow: 0 0 15px rgba(231, 76, 60, 1), 0 0 20px rgba(231, 76, 60, 0.7);
    }
  }

  @keyframes glow-blue {
    0%, 100% {
      text-shadow: 0 0 5px rgba(52, 152, 219, 0.7);
    }
    50% {
      text-shadow: 0 0 15px rgba(52, 152, 219, 1), 0 0 20px rgba(52, 152, 219, 0.7);
    }
  }

  @keyframes gradientShift {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideUp {
    from {
      transform: translateY(50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Responsive adjustments */
  @media (max-width: 1200px) {
    .dashboard {
      grid-template-columns: 1fr;
    }
    
    .formula-pending-container {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .header {
      flex-direction: column;
    }
    
    .mixers {
      flex-wrap: wrap;
    }
    
    .mixer {
      flex: 1 0 45%;
      margin-bottom: 10px;
    }
    
    .controls {
      grid-template-columns: 1fr;
    }
    
    .timer {
      font-size: 3rem;
    }

    .modal-controls {
      flex-direction: column;
    }

    .prev-item-details {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 480px) {
    .timer {
      font-size: 2.5rem;
    }
  }
</style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="box">ADVANCED PRODUCTION CONTROL</div>
    <div class="box">STATUS: <span class="status-text status-standby">STANDBY</span></div>
    <div class="box" id="current-date-time">SEPTEMBER 23, 2025 03:33:10 PM</div>
    <div class="settings-container">
      <button class="settings-btn"><i class="fas fa-cog"></i> SETTINGS</button>
      <div class="settings-dropdown">
        <a href="#" onclick="openModal('theme-modal')"><i class="fas fa-palette"></i> THEME</a>
        <a href="#" onclick="openModal('maintenance-modal')"><i class="fas fa-tools"></i> REQUEST MAINTENANCE</a>
        <a href="#" onclick="openModal('history-modal')"><i class="fas fa-history"></i> PRODUCTION HISTORY</a>
      </div>
    </div>
  </div>

  <div class="dashboard">
    <!-- Left Column -->
    <div>
      <div class="mixers">
        <div class="mixer offline" data-mixer="1">
          <span class="mixer-number">1</span>
          <span class="mixer-label"><i class="fa-solid fa-circle-arrow-down"></i> MIXER</span>
          <div class="mixer-tooltip">No recipe assigned (Offline)</div>
        </div>
        <div class="mixer" data-mixer="2">
          <span class="mixer-number">2</span>
          <span class="mixer-label"><i class="fa-solid fa-circle-arrow-down"></i> MIXER</span>
          <div class="mixer-tooltip">CHAMPION 5 GRAINS (5 batches)</div>
        </div>
        <div class="mixer" data-mixer="3">
          <span class="mixer-number">3</span>
          <span class="mixer-label"><i class="fa-solid fa-circle-arrow-down"></i> MIXER</span>
          <div class="mixer-tooltip">PERFORMANCE 4X (2 batches)</div>
        </div>
        <div class="mixer" data-mixer="4">
          <span class="mixer-number">4</span>
          <span class="mixer-label"><i class="fa-solid fa-circle-arrow-down"></i> MIXER</span>
          <div class="mixer-tooltip">WARBIRD 7 KINDS (8 batches)</div>
        </div>
      </div>

      <div class="info-box">
        <div class="timer-container">
          <div class="timer hide">00:00:00</div>
          <div class="timer-label">Elapsed Time</div>
        </div>
        <span><i class="fas fa-id-badge"></i> PRODUCTION ID: <span id="production-id">None</span></span>
        <span><i class="fas fa-box"></i> ITEM: <span id="current-item">None</span></span>
        <div class="progress-bar">
          <div class="progress" id="batch-progress"></div>
        </div>
        <span><i class="fas fa-chart-bar"></i> BATCH PROGRESS: <span id="progress-percent">0%</span></span>
      </div>

      <!-- Previous Item Box -->
      <div class="prev-item-box" id="prev-item-box">
        <div class="prev-item-title">PREVIOUS PRODUCTION</div>
        <div class="prev-item-details" id="prev-item-details">
          <!-- Details will be populated here -->
        </div>
      </div>

      <!-- Fault Panel -->
      <div class="fault-panel" id="fault-panel">
        <h3 style="color: var(--danger); text-align: center; margin-bottom: 10px;">ACTIVE FAULTS</h3>
        <div id="fault-list">
          <!-- Faults will be dynamically added here -->
        </div>
      </div>

      <div class="controls">
        <div class="btn green" onclick="openModal('conveyor-modal')"><i class="fa-solid fa-gear"></i> CONVEYORS</div>
        <div class="btn green" onclick="openModal('mixer-modal')"><i class="fa-solid fa-gear"></i> MIXER</div>
        <div class="btn red" onclick="openModal('emergency-modal')"><i class="fas fa-exclamation-triangle"></i> E-STOP</div>
        <div class="btn blue" onclick="refreshData()"><i class="fas fa-sync-alt"></i> REFRESH</div>
      </div>
    </div>

    <!-- Right Column -->
    <div>
      <div class="formula-pending-container">
        <div class="card formula-section">
          <h2>FORMULATION</h2>
          <div class="scrollable">
            <table id="formula-table">
              <thead>
                <tr><th>BIN NO.</th><th>ITEM NAME</th><th>REQUIRED (KG)</th><th>DROPS</th><th>WBIN(KG)</th><th>WEIGHT STABILITY</th><th>ACTUAL (KG)</th><th>STATUS</th><th>SERVO-POS</th></tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card pending-section">
          <h2>PENDING PRODUCTION</h2>
          <div class="pending-scroll">
            <table id="pending-table">
              <thead>
                <tr><th>DATE</th><th>QTY</th><th>CODE</th><th>MIXER</th><th>STATUS</th></tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="dispense-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Confirm Dispense</h3>
      <button class="close-modal" onclick="closeModal('dispense-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <p class="modal-text" id="dispense-message">Do you want to dispense ITEM_NAME to Mixer #?</p>
      <div class="modal-controls">
        <button class="modal-btn confirm" onclick="confirmDispense()">YES, START DISPENSING</button>
        <button class="modal-btn cancel" onclick="closeModal('dispense-modal')">CANCEL</button>
      </div>
    </div>
  </div>
</div>

<div id="conveyor-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Conveyor Controls</h3>
      <button class="close-modal" onclick="closeModal('conveyor-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <p class="modal-text">Control the conveyor system for material handling.</p>
      <div class="modal-controls">
        <button class="modal-btn confirm">START ALL</button>
        <button class="modal-btn cancel">STOP ALL</button>
      </div>
    </div>
  </div>
</div>

<div id="mixer-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Mixer Controls</h3>
      <button class="close-modal" onclick="closeModal('mixer-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <p class="modal-text">Control the mixing operations.</p>
      <div class="modal-controls">
        <button class="modal-btn confirm">START MIXING</button>
        <button class="modal-btn cancel">EMERGENCY STOP</button>
      </div>
    </div>
  </div>
</div>

<div id="emergency-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Emergency Controls</h3>
      <button class="close-modal" onclick="closeModal('emergency-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <p class="modal-text" style="color: var(--danger); font-weight: bold;">WARNING: This will stop all operations immediately!</p>
      <div class="modal-controls">
        <button class="modal-btn cancel" style="background: var(--danger);" onclick="emergencyStop()">EMERGENCY STOP ALL</button>
        <button class="modal-btn confirm" onclick="closeModal('emergency-modal')">CANCEL</button>
      </div>
    </div>
  </div>
</div>

<div id="completion-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Production Complete</h3>
      <button class="close-modal" onclick="closeModal('completion-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <p class="modal-text" id="completion-message">Production ID - Batch Item Name is done dispensing</p>
      
      <div class="dispensing-details" id="dispensing-details">
        <!-- Details will be added here -->
      </div>
      
      <div class="modal-controls">
        <button class="modal-btn confirm" onclick="closeCompletionModal()">OK</button>
      </div>
    </div>
  </div>
</div>

<div id="fault-details-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Fault Details</h3>
      <button class="close-modal" onclick="closeModal('fault-details-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <p class="modal-text" id="fault-details-message"></p>
      <div class="modal-controls">
        <button class="modal-btn confirm" onclick="acknowledgeFault()">ACKNOWLEDGE</button>
        <button class="modal-btn cancel" onclick="closeModal('fault-details-modal')">CANCEL</button>
      </div>
    </div>
  </div>
</div>

<!-- Previous Production Details Modal -->
<div id="prev-production-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Previous Production Details</h3>
      <button class="close-modal" onclick="closeModal('prev-production-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="dispensing-details" id="prev-dispensing-details">
        <!-- Details will be added here -->
      </div>
      
      <div class="prev-production-table-container">
        <h4>Formulation Details</h4>
        <table class="prev-production-table" id="prev-production-table">
          <thead>
            <tr><th>BIN NO.</th><th>ITEM NAME</th><th>REQUIRED (KG)</th><th>ACTUAL (KG)</th><th>DIFFERENCE</th></tr>
          </thead>
          <tbody>
            <!-- Rows will be added here -->
          </tbody>
        </table>
      </div>
      
      <div class="modal-controls">
        <button class="modal-btn confirm" onclick="closeModal('prev-production-modal')">CLOSE</button>
      </div>
    </div>
  </div>
</div>

<!-- New Modals -->
<div id="theme-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Theme Configuration</h3>
      <button class="close-modal" onclick="closeModal('theme-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <p class="modal-text">Select a theme for the dashboard:</p>
      <div class="theme-options">
        <div class="theme-option theme-dark active" onclick="setTheme('dark')">
          <i class="fas fa-moon"></i><br>Dark
        </div>
        <div class="theme-option theme-light" onclick="setTheme('light')">
          <i class="fas fa-sun"></i><br>Light
        </div>
        <div class="theme-option theme-traditional" onclick="setTheme('traditional')">
          <i class="fas fa-feather"></i><br>Traditional
        </div>
        <div class="theme-option theme-soft" onclick="setTheme('soft')">
          <i class="fas fa-pastafarianism"></i><br>Soft
        </div>
      </div>
      <div class="modal-controls">
        <button class="modal-btn confirm" onclick="closeModal('theme-modal')">APPLY</button>
        <button class="modal-btn cancel" onclick="closeModal('theme-modal')">CANCEL</button>
      </div>
    </div>
  </div>
</div>

<div id="maintenance-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Request Maintenance</h3>
      <button class="close-modal" onclick="closeModal('maintenance-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="department">Department:</label>
        <select id="department" onchange="updateMaintenanceForm()">
          <option value="">Select Department</option>
          <option value="admin">Admin</option>
          <option value="automation">Automation</option>
          <option value="electrical">Electrical</option>
          <option value="mechanical">Mechanical</option>
        </select>
      </div>
      
      <div class="form-group" id="issue-type-group" style="display: none;">
        <label for="issue-type">Issue Type:</label>
        <select id="issue-type" onchange="updateRequestSentence()">
          <option value="">Select Issue Type</option>
        </select>
      </div>
      
      <div class="form-group checkbox">
        <input type="checkbox" id="bin-related" onchange="toggleBinSelection()">
        <label for="bin-related">Is this issue related to a specific bin?</label>
      </div>
      
      <div class="form-group" id="bin-selection-group" style="display: none;">
        <label for="bin-number">Bin Number:</label>
        <select id="bin-number" onchange="updateRequestSentence()">
          <option value="">Select Bin</option>
          <!-- Options will be populated dynamically -->
        </select>
      </div>
      
      <div class="request-sentence" id="request-sentence">
        Please select department and issue type to generate request.
      </div>
      
      <div class="modal-controls">
        <button class="modal-btn confirm" onclick="submitMaintenanceRequest()">SEND REQUEST</button>
        <button class="modal-btn cancel" onclick="closeModal('maintenance-modal')">CANCEL</button>
      </div>
    </div>
  </div>
</div>

<div id="history-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Production History</h3>
      <button class="close-modal" onclick="closeModal('history-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <p class="modal-text">Recent production batches:</p>
      <div id="history-list" style="max-height: 300px; overflow-y: auto;">
        <!-- History items will be added here -->
      </div>
      <div class="modal-controls">
        <button class="modal-btn confirm" onclick="closeModal('history-modal')">CLOSE</button>
      </div>
    </div>
  </div>
</div>

<script>
  // JSON Data with max weight for each bin
  const productionData = {
    "items": [
      {"id": 1, "name": "BARLEY", "maxWeight": 150},
      {"id": 2, "name": "POP CORN", "maxWeight": 200},
      {"id": 3, "name": "CRACK CORN", "maxWeight": 150},
      {"id": 4, "name": "DUN PEAS", "maxWeight": 200},
      {"id": 5, "name": "GREEN MONGO", "maxWeight": 150},
      {"id": 6, "name": "GREEN PEAS", "maxWeight": 200},
      {"id": 7, "name": "YELLOW CORN GRAINS", "maxWeight": 500},
      {"id": 8, "name": "WHEAT WHITE", "maxWeight": 150},
      {"id": 9, "name": "WHEAT RED", "maxWeight": 200},
      {"id": 10, "name": "SORGHUM", "maxWeight": 150},
      {"id": 11, "name": "SUNFLOWER", "maxWeight": 200},
      {"id": 12, "name": "VETCH SEEDS", "maxWeight": 150},
      {"id": 13, "name": "SAFFFLOWER", "maxWeight": 200},
      {"id": 14, "name": "GROAT OATS", "maxWeight": 150},
      {"id": 15, "name": "MAPLE PEAS", "maxWeight": 200},
      {"id": 16, "name": "JOCKEY OATS", "maxWeight": 150},
      {"id": 17, "name": "CLIPPED OATS", "maxWeight": 200},
      {"id": 18, "name": "WHITE LUPINS", "maxWeight": 150},
      {"id": 19, "name": "BLACK KIDNEY BINS", "maxWeight": 200},
      {"id": 20, "name": "RED PELLETS", "maxWeight": 150},
      {"id": 21, "name": "SOYA BEANS", "maxWeight": 500},
      {"id": 22, "name": "CADIOS", "maxWeight": 150}
    ],
    "recipes": [
      {
        "id": "WARB7K",
        "name": "WARBIRD 7 KINDS",
        "description": "Premium cock feed for strength and stamina",
        "priority": 1,
        "batches": 8,
        "mixer": 4,
        "ingredients": [
          {"itemId": 1, "required": 150},
          {"itemId": 2, "required": 120},
          {"itemId": 7, "required": 180},
          {"itemId": 8, "required": 100},
          {"itemId": 10, "required": 150},
          {"itemId": 21, "required": 200},
          {"itemId": 22, "required": 100}
        ]
      },
      {
        "id": "CHAMP5G",
        "name": "CHAMPION 5 GRAINS",
        "description": "High-energy feed for competition cocks",
        "priority": 2,
        "batches": 5,
        "mixer": 2,
        "ingredients": [
          {"itemId": 3, "required": 200},
          {"itemId": 7, "required": 250},
          {"itemId": 10, "required": 150},
          {"itemId": 14, "required": 200},
          {"itemId": 16, "required": 200}
        ]
      },
      {
        "id": "MAINT8B",
        "name": "MAINTENANCE 8 BLEND",
        "description": "Balanced nutrition for regular maintenance",
        "priority": 1,
        "batches": 3,
        "mixer": 3,
        "ingredients": [
          {"itemId": 1, "required": 125},
          {"itemId": 4, "required": 125},
          {"itemId": 6, "required": 125},
          {"itemId": 8, "required": 125},
          {"itemId": 11, "required": 125},
          {"itemId": 13, "required": 125},
          {"itemId": 18, "required": 125},
          {"itemId": 21, "required": 125}
        ]
      },
      {
        "id": "RECOV6M",
        "name": "RECOVERY 6 MIX",
        "description": "Special blend for post-fight recovery",
        "priority": 1,
        "batches": 6,
        "mixer": null,
        "ingredients": [
          {"itemId": 5, "required": 170},
          {"itemId": 9, "required": 170},
          {"itemId": 12, "required": 165},
          {"itemId": 15, "required": 165},
          {"itemId": 19, "required": 165},
          {"itemId": 20, "required": 165}
        ]
      },
      {
        "id": "GROW9P",
        "name": "GROWTH 9 PROTEIN",
        "description": "High-protein feed for young cocks",
        "priority": 1,
        "batches": 4,
        "mixer": null,
        "ingredients": [
          {"itemId": 2, "required": 110},
          {"itemId": 5, "required": 110},
          {"itemId": 8, "required": 110},
          {"itemId": 10, "required": 110},
          {"itemId": 14, "required": 110},
          {"itemId": 16, "required": 110},
          {"itemId": 18, "required": 110},
          {"itemId": 21, "required": 110},
          {"itemId": 22, "required": 110}
        ]
      },
      {
        "id": "PERF4X",
        "name": "PERFORMANCE 4X",
        "description": "Premium performance enhancer",
        "priority": 2,
        "batches": 2,
        "mixer": null,
        "ingredients": [
          {"itemId": 7, "required": 250},
          {"itemId": 11, "required": 250},
          {"itemId": 17, "required": 250},
          {"itemId": 21, "required": 250}
        ]
      }
    ]
  };

  // Enhanced Application state
  let appState = {
    status: 'standby',
    activeMixer: null,
    timerSeconds: 0,
    timerInterval: null,
    progress: 0,
    isDispensing: false,
    binStatus: {},
    binFlowRates: {},
    binCalibrationTimes: {},
    binDropTimes: {},
    totalRequiredWeight: 0,
    totalActualWeight: 0,
    currentItem: "None",
    productionId: "None",
    completedBins: 0,
    activeFaults: [],
    servoPositions: {},
    weightHistory: [],
    mixingTimerStarted: false,
    eStopActive: false,
    bulkServoPosition: 100,
    dribbleServoPosition: 25,
    stabilityTimeout: 30,
    overshootTolerance: 2,
    materialType: "Granules",
    vibratorEnabled: true,
    faultRetryCount: {},
    maxRetries: 3,
    currentRecipe: null,
    currentTheme: 'dark',
    hiddenRows: [], // Store hidden rows during dispensing
    previousProduction: null // Store previous production details
  };

  // Initialize the application
  function initializeApp() {
    // Initialize date/time display
    updateDateTime();
    setInterval(updateDateTime, 1000);
    
    // Initialize bins
    initializeBins();
    
    // Update pending production table
    updatePendingProductionTable();
    
    // Set up mixer click handlers
    setupMixerHandlers();
    
    // Set up previous item box click handler
    document.getElementById('prev-item-box').addEventListener('click', showPreviousProductionDetails);
  }

  // Initialize bins with data from JSON
  function initializeBins() {
    const formulaTable = document.getElementById('formula-table');
    const tbody = formulaTable.querySelector('tbody');
    tbody.innerHTML = '';
    
    productionData.items.forEach(item => {
      const row = document.createElement('tr');
      row.setAttribute('data-bin', item.id);
      row.innerHTML = `
        <td>${item.id}</td>
        <td>${item.name}</td>
        <td>0.0000</td>
        <td>0</td>
        <td>0.0000</td>
        <td><span class="stability st">ST</span></td>
        <td>0.0000</td>
        <td><span class="status standby"></span> STANDBY</td>
        <td class="servo-pos">0%</td>
      `;
      tbody.appendChild(row);
      
      // Initialize bin state
      appState.binStatus[item.id] = 'standby';
      appState.binFlowRates[item.id] = 0.1 + Math.random() * 0.3;
      appState.binCalibrationTimes[item.id] = 2000 + Math.random() * 3000;
      appState.binDropTimes[item.id] = 1000 + Math.random() * 4000;
      appState.servoPositions[item.id] = 0;
      appState.faultRetryCount[item.id] = 0;
    });
  }

  // Update date and time display
  function updateDateTime() {
    const now = new Date();
    const options = { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: true 
    };
    document.getElementById('current-date-time').textContent = now.toLocaleDateString('en-US', options).toUpperCase();
  }

  // Set up mixer click handlers
  function setupMixerHandlers() {
    const mixers = document.querySelectorAll('.mixer:not(.offline)');
    mixers.forEach(mixer => {
      mixer.addEventListener('click', () => {
        if (appState.isDispensing) return;
        
        const mixerNumber = parseInt(mixer.getAttribute('data-mixer'));
        const recipe = productionData.recipes.find(r => r.mixer === mixerNumber);
        
        if (recipe && recipe.batches > 0) {
          // Set the message in the modal
          document.getElementById('dispense-message').textContent = 
            `Do you want to dispense ${recipe.name} to Mixer ${mixerNumber}?`;
          
          // Store the selected recipe and mixer
          appState.selectedRecipe = recipe;
          appState.selectedMixer = mixerNumber;
          
          // Open the confirmation modal
          openModal('dispense-modal');
        }
      });
    });
  }

  // Update pending production table
  function updatePendingProductionTable() {
    const pendingTable = document.getElementById('pending-table');
    const tbody = pendingTable.querySelector('tbody');
    tbody.innerHTML = '';
    
    // Add dates to recipes for display
    const now = new Date();
    productionData.recipes.forEach((recipe, index) => {
      const date = new Date(now.getTime() + (index * 24 * 60 * 60 * 1000));
      const dateStr = `${date.getMonth()+1}/${date.getDate()}/${date.getFullYear()}`;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${dateStr}</td>
        <td>${recipe.batches}</td>
        <td>${recipe.id}</td>
        <td>${recipe.mixer || ''}</td>
        <td>${recipe.mixer ? 'ASSIGNED' : 'PENDING'}</td>
      `;
      tbody.appendChild(row);
    });
  }

  // Confirm dispense function
  function confirmDispense() {
    // Start the timer and dispensing process
    startTimer();
    
    // Update the active mixer
    if (appState.activeMixer) {
      const prevMixer = document.querySelector(`.mixer[data-mixer="${appState.activeMixer}"]`);
      if (prevMixer) {
        prevMixer.classList.remove('active');
      }
    }
    
    // Activate the selected mixer
    const selectedMixer = document.querySelector(`.mixer[data-mixer="${appState.selectedMixer}"]`);
    if (selectedMixer) {
      selectedMixer.classList.add('active');
      appState.activeMixer = appState.selectedMixer;
    }
    
    // Set current recipe
    appState.currentRecipe = appState.selectedRecipe;
    
    // Update current item and production ID
    appState.currentItem = appState.selectedRecipe.name;
    appState.productionId = `P${new Date().getFullYear()}${(new Date().getMonth()+1).toString().padStart(2, '0')}${new Date().getDate().toString().padStart(2, '0')}00${appState.selectedMixer}`;
    
    document.getElementById('current-item').textContent = appState.currentItem;
    document.getElementById('production-id').textContent = appState.productionId;
    
    // Update formulation table with recipe ingredients (hide non-recipe items)
    updateFormulationTable();
    
    // Close the modal
    closeModal('dispense-modal');
    
    // Log the start of dispensing
    logEvent(`Dispensing started for ${appState.currentItem} to Mixer ${appState.activeMixer}`);
  }

  // Update formulation table with recipe ingredients and hide non-recipe items
  function updateFormulationTable() {
    const formulaTable = document.getElementById('formula-table');
    const tbody = formulaTable.querySelector('tbody');
    const allRows = tbody.querySelectorAll('tr');
    
    // Store hidden rows for later restoration
    appState.hiddenRows = [];
    
    // Reset all rows first
    allRows.forEach(row => {
      const binNo = parseInt(row.getAttribute('data-bin'));
      const isInRecipe = appState.currentRecipe.ingredients.some(i => i.itemId === binNo);
      
      if (isInRecipe) {
        // Show recipe items
        row.classList.remove('hidden');
        row.classList.remove('restoring');
        
        // Find the ingredient
        const ingredient = appState.currentRecipe.ingredients.find(i => i.itemId === binNo);
        const item = productionData.items.find(i => i.id === binNo);
        
        // Calculate drops
        const drops = Math.ceil(ingredient.required / item.maxWeight);
        
        // Update row
        row.cells[2].textContent = ingredient.required.toFixed(4); // Required weight
        row.cells[3].textContent = drops; // Drops
        row.cells[4].textContent = "0.0000"; // WBIN weight
        row.cells[5].innerHTML = '<span class="stability un">UN</span>'; // Weight stability
        row.cells[6].textContent = "0.0000"; // Actual weight
        row.cells[7].innerHTML = '<span class="status standby"></span> STANDBY'; // Status
        row.cells[8].textContent = "0%"; // Servo position
        
        // Reset bin status
        appState.binStatus[binNo] = 'standby';
      } else {
        // Hide non-recipe items with animation
        row.classList.add('hidden');
        appState.hiddenRows.push(row);
      }
    });
    
    // Start dispensing simulation for recipe bins
    startDispensingSimulation();
  }

  // Start dispensing simulation for recipe bins with loop based on drops
  function startDispensingSimulation() {
    // Reset total weights
    appState.totalRequiredWeight = 0;
    appState.totalActualWeight = 0;
    
    // Calculate total required weight for the recipe
    appState.currentRecipe.ingredients.forEach(ingredient => {
      appState.totalRequiredWeight += ingredient.required;
    });
    
    // Start simulation for each ingredient with loop dispensing
    appState.currentRecipe.ingredients.forEach(ingredient => {
      simulateBinDispensingWithDrops(ingredient.itemId, ingredient.required);
    });
  }

  // Simulate bin dispensing with loop based on drops
  function simulateBinDispensingWithDrops(binNo, requiredWeight) {
    const row = document.querySelector(`tr[data-bin="${binNo}"]`);
    if (!row) return;
    
    const statusCell = row.cells[7];
    const actualCell = row.cells[6];
    const wbinCell = row.cells[4];
    const stabilityCell = row.cells[5];
    const servoPosCell = row.cells[8];
    const dropsCell = row.cells[3];
    
    // Update status to DISPENSING
    updateBinStatus(binNo, 'dispensing', statusCell);
    
    // Update stability to UN
    stabilityCell.innerHTML = '<span class="stability un">UN</span>';
    
    // Get item details
    const item = productionData.items.find(i => i.id === binNo);
    const maxWeightPerDrop = item.maxWeight;
    const totalDrops = Math.ceil(requiredWeight / maxWeightPerDrop);
    let currentDrop = 1;
    let totalDispensed = 0;
    
    dropsCell.textContent = totalDrops;
    
    // Function to process a single drop
    const processDrop = () => {
      if (appState.eStopActive) return;
      
      const remainingWeight = requiredWeight - totalDispensed;
      const dropWeight = Math.min(remainingWeight, maxWeightPerDrop);
      
      // Simulate filling the weigh bin
      let wbinWeight = 0;
      const fillInterval = setInterval(() => {
        if (appState.eStopActive) {
          clearInterval(fillInterval);
          return;
        }
        
        if (wbinWeight < dropWeight) {
          wbinWeight += appState.binFlowRates[binNo] * 15;
          wbinWeight = Math.min(wbinWeight, dropWeight);
          wbinCell.textContent = wbinWeight.toFixed(4);
          
          // Update servo position based on remaining weight
          const remainingInDrop = dropWeight - wbinWeight;
          if (remainingInDrop > dropWeight * 0.1) {
            setServoPosition(binNo, appState.bulkServoPosition, servoPosCell);
          } else {
            setServoPosition(binNo, appState.dribbleServoPosition, servoPosCell);
          }
        } else {
          clearInterval(fillInterval);
          
          // Weight reached, wait for stability
          setTimeout(() => {
            stabilityCell.innerHTML = '<span class="stability st">ST</span>';
            
            // After stability, drop the material
            setTimeout(() => {
              // Transfer weight to actual
              const actualWeight = parseFloat(actualCell.textContent) + wbinWeight;
              actualCell.textContent = actualWeight.toFixed(4);
              totalDispensed += wbinWeight;
              appState.totalActualWeight += wbinWeight;
              updateProgress();
              
              // Reset weigh bin
              wbinWeight = 0;
              wbinCell.textContent = "0.0000";
              stabilityCell.innerHTML = '<span class="stability un">UN</span>';
              
              currentDrop++;
              
              // If all drops are done, finish this bin
              if (currentDrop > totalDrops) {
                // Wait for final stability
                setTimeout(() => {
                  stabilityCell.innerHTML = '<span class="stability st">ST</span>';
                  
                  // Update status to done
                  updateBinStatus(binNo, 'done', statusCell);
                  setServoPosition(binNo, 0, servoPosCell);
                  
                  // Check if all bins are done
                  checkAllBinsDone();
                }, 1000);
              } else {
                // Process next drop
                setTimeout(processDrop, 500);
              }
            }, 500);
          }, 1000);
        }
      }, 100);
    };
    
    // Start the first drop
    processDrop();
  }

  // Update progress bar
  function updateProgress() {
    const progressBar = document.getElementById('batch-progress');
    const progressPercent = document.getElementById('progress-percent');
    
    appState.progress = (appState.totalActualWeight / appState.totalRequiredWeight) * 100;
    progressBar.style.width = `${appState.progress}%`;
    progressPercent.textContent = isNaN(appState.progress) ? '0%' : `${Math.round(appState.progress)}%`;
  }

  // Update bin status
  function updateBinStatus(binNo, status, statusCell) {
    appState.binStatus[binNo] = status;
    statusCell.innerHTML = `<span class="status ${status}"></span> ${status.toUpperCase()}`;
  }

  // Set servo position
  function setServoPosition(binNo, position, servoPosCell) {
    appState.servoPositions[binNo] = position;
    servoPosCell.textContent = position + '%';
  }

  // Check if all bins are done
  function checkAllBinsDone() {
    const recipeBins = appState.currentRecipe.ingredients.map(i => i.itemId);
    const doneBins = recipeBins.filter(bin => appState.binStatus[bin] === 'done');
    
    if (doneBins.length >= recipeBins.length) {
      // All bins are done
      stopTimer();
      updateStatus('done');
      
      // Decrease batch count
      appState.currentRecipe.batches--;
      
      // Update pending production table
      updatePendingProductionTable();
      
      // Update mixer tooltip
      updateMixerTooltips();
      
      // Store production details for history
      storeProductionDetails();
      
      // Show completion modal with dispensing details
      showCompletionModal();
      
      // Restore mixers to default
      restoreMixersToDefault();
      
      // Log completion
      logEvent(`Batch completed for ${appState.currentItem} on Mixer ${appState.activeMixer}`);
    }
  }

  // Store production details for history
  function storeProductionDetails() {
    const formulaTable = document.getElementById('formula-table');
    const tbody = formulaTable.querySelector('tbody');
    const allRows = tbody.querySelectorAll('tr');
    
    const productionDetails = {
      productionId: appState.productionId,
      recipeName: appState.currentItem,
      totalRequired: appState.totalRequiredWeight,
      totalActual: appState.totalActualWeight,
      timestamp: new Date().toLocaleString(),
      ingredients: []
    };
    
    // Store details for each ingredient
    appState.currentRecipe.ingredients.forEach(ingredient => {
      const row = document.querySelector(`tr[data-bin="${ingredient.itemId}"]`);
      if (row) {
        const required = parseFloat(row.cells[2].textContent);
        const actual = parseFloat(row.cells[6].textContent);
        const difference = actual - required;
        
        productionDetails.ingredients.push({
          binNo: ingredient.itemId,
          itemName: productionData.items.find(i => i.id === ingredient.itemId).name,
          required: required,
          actual: actual,
          difference: difference
        });
      }
    });
    
    appState.previousProduction = productionDetails;
    
    // Update previous item box
    updatePreviousItemBox();
  }

  // Update previous item box with production details
  function updatePreviousItemBox() {
    const prevItemBox = document.getElementById('prev-item-box');
    const prevItemDetails = document.getElementById('prev-item-details');
    
    if (appState.previousProduction) {
      const weightDifference = appState.previousProduction.totalActual - appState.previousProduction.totalRequired;
      const differencePercent = (Math.abs(weightDifference) / appState.previousProduction.totalRequired) * 100;
      
      prevItemDetails.innerHTML = `
        <div class="prev-item-detail"><span>ID:</span> ${appState.previousProduction.productionId}</div>
        <div class="prev-item-detail"><span>Recipe:</span> ${appState.previousProduction.recipeName}</div>
        <div class="prev-item-detail"><span>Required:</span> ${appState.previousProduction.totalRequired.toFixed(2)} kg</div>
        <div class="prev-item-detail"><span>Actual:</span> ${appState.previousProduction.totalActual.toFixed(2)} kg</div>
        <div class="prev-item-detail"><span>Difference:</span> ${weightDifference >= 0 ? '+' : ''}${weightDifference.toFixed(2)} kg</div>
        <div class="prev-item-detail"><span>Status:</span> ${weightDifference > 0 ? 'OVER' : weightDifference < 0 ? 'UNDER' : 'EXACT'}</div>
      `;
      
      prevItemBox.classList.add('active');
    }
  }

  // Show previous production details modal
  function showPreviousProductionDetails() {
    if (!appState.previousProduction) return;
    
    const prevDispensingDetails = document.getElementById('prev-dispensing-details');
    const prevProductionTable = document.getElementById('prev-production-table');
    const tbody = prevProductionTable.querySelector('tbody');
    
    // Clear previous table data
    tbody.innerHTML = '';
    
    const weightDifference = appState.previousProduction.totalActual - appState.previousProduction.totalRequired;
    const differencePercent = (Math.abs(weightDifference) / appState.previousProduction.totalRequired) * 100;
    
    // Update details section
    prevDispensingDetails.innerHTML = `
      <div class="detail-item">
        <span class="detail-label">Production ID:</span>
        <span class="detail-value">${appState.previousProduction.productionId}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Recipe:</span>
        <span class="detail-value">${appState.previousProduction.recipeName}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Total Required Weight:</span>
        <span class="detail-value">${appState.previousProduction.totalRequired.toFixed(2)} kg</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Total Actual Weight:</span>
        <span class="detail-value">${appState.previousProduction.totalActual.toFixed(2)} kg</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Weight Difference:</span>
        <span class="detail-value">${weightDifference >= 0 ? '+' : ''}${weightDifference.toFixed(2)} kg (${differencePercent.toFixed(2)}%)</span>
      </div>
      <div class="weight-difference ${weightDifference > 0 ? 'positive' : weightDifference < 0 ? 'negative' : 'exact'}">
        ${weightDifference > 0 ? 'OVERWEIGHT' : weightDifference < 0 ? 'UNDERWEIGHT' : 'EXACT WEIGHT'}
      </div>
    `;
    
    // Populate table with ingredient details
    appState.previousProduction.ingredients.forEach(ingredient => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${ingredient.binNo}</td>
        <td>${ingredient.itemName}</td>
        <td>${ingredient.required.toFixed(2)}</td>
        <td>${ingredient.actual.toFixed(2)}</td>
        <td>${ingredient.difference >= 0 ? '+' : ''}${ingredient.difference.toFixed(2)}</td>
      `;
      tbody.appendChild(row);
    });
    
    openModal('prev-production-modal');
  }

  // Show completion modal with dispensing details
  function showCompletionModal() {
    const completionMessage = document.getElementById('completion-message');
    completionMessage.textContent = `${appState.productionId} - Batch ${appState.currentItem} is done dispensing in ${formatTime(appState.timerSeconds)}`;
    
    // Calculate weight difference
    const weightDifference = appState.totalActualWeight - appState.totalRequiredWeight;
    const differencePercent = (Math.abs(weightDifference) / appState.totalRequiredWeight) * 100;
    
    // Create details HTML
    const detailsDiv = document.getElementById('dispensing-details');
    detailsDiv.innerHTML = `
      <div class="detail-item">
        <span class="detail-label">Production ID:</span>
        <span class="detail-value">${appState.productionId}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Recipe:</span>
        <span class="detail-value">${appState.currentItem}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Total Required Weight:</span>
        <span class="detail-value">${appState.totalRequiredWeight.toFixed(2)} kg</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Total Actual Weight:</span>
        <span class="detail-value">${appState.totalActualWeight.toFixed(2)} kg</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Weight Difference:</span>
        <span class="detail-value">${weightDifference >= 0 ? '+' : ''}${weightDifference.toFixed(2)} kg (${differencePercent.toFixed(2)}%)</span>
      </div>
      <div class="weight-difference ${weightDifference > 0 ? 'positive' : weightDifference < 0 ? 'negative' : 'exact'}">
        ${weightDifference > 0 ? 'OVERWEIGHT' : weightDifference < 0 ? 'UNDERWEIGHT' : 'EXACT WEIGHT'}
      </div>
    `;
    
    openModal('completion-modal');
  }

  // Close completion modal and restore hidden rows
  function closeCompletionModal() {
    closeModal('completion-modal');
    
    // Restore hidden rows with animation
    restoreHiddenRows();
  }

  // Restore hidden rows with smooth animation
  function restoreHiddenRows() {
    const formulaTable = document.getElementById('formula-table');
    const tbody = formulaTable.querySelector('tbody');
    
    // Add restoring class to all rows for animation
    const allRows = tbody.querySelectorAll('tr');
    allRows.forEach(row => {
      row.classList.add('restoring');
    });
    
    // Restore hidden rows
    appState.hiddenRows.forEach(row => {
      row.classList.remove('hidden');
    });
    
    // Clear the hidden rows array
    appState.hiddenRows = [];
    
    // Animate the restoration
    setTimeout(() => {
      allRows.forEach(row => {
        row.classList.remove('restoring');
      });
    }, 100);
  }

  // Restore mixers to default state
  function restoreMixersToDefault() {
    // Deactivate current mixer
    if (appState.activeMixer) {
      const activeMixer = document.querySelector(`.mixer[data-mixer="${appState.activeMixer}"]`);
      if (activeMixer) {
        activeMixer.classList.remove('active');
      }
      appState.activeMixer = null;
    }
    
    // Reset current recipe
    appState.currentRecipe = null;
    
    // Reset production info
    appState.currentItem = "None";
    appState.productionId = "None";
    document.getElementById('current-item').textContent = appState.currentItem;
    document.getElementById('production-id').textContent = appState.productionId;
    
    // Reset progress
    appState.progress = 0;
    document.getElementById('batch-progress').style.width = '0%';
    document.getElementById('progress-percent').textContent = '0%';
    
    // Reset timer display
    document.querySelector('.timer').textContent = '00:00:00';
  }

  // Update mixer tooltips
  function updateMixerTooltips() {
    productionData.recipes.forEach(recipe => {
      if (recipe.mixer) {
        const mixer = document.querySelector(`.mixer[data-mixer="${recipe.mixer}"]`);
        if (mixer) {
          const tooltip = mixer.querySelector('.mixer-tooltip');
          tooltip.textContent = `${recipe.name} (${recipe.batches} batches)`;
        }
      }
    });
  }

  // Format time
  function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  // Timer functionality
  function startTimer() {
    if (appState.timerInterval) {
      clearInterval(appState.timerInterval);
    }
    
    appState.timerSeconds = 0;
    appState.timerInterval = setInterval(updateTimer, 1000);
    
    // Show the timer
    const timerElement = document.querySelector('.timer');
    timerElement.classList.remove('hide');
    timerElement.classList.add('show');
    
    updateTimerDisplay();
    
    // Update status to dispensing
    updateStatus('dispensing');
    appState.isDispensing = true;
    
    // Disable mixers during dispensing
    const mixers = document.querySelectorAll('.mixer:not(.offline)');
    mixers.forEach(mixer => {
      mixer.classList.add('disabled');
    });
  }

  function stopTimer() {
    if (appState.timerInterval) {
      clearInterval(appState.timerInterval);
      appState.timerInterval = null;
    }
    
    // Hide the timer
    const timerElement = document.querySelector('.timer');
    timerElement.classList.remove('show');
    timerElement.classList.add('hide');
    
    // Update status to standby
    updateStatus('standby');
    appState.isDispensing = false;
    
    // Re-enable mixers
    const mixers = document.querySelectorAll('.mixer:not(.offline)');
    mixers.forEach(mixer => {
      mixer.classList.remove('disabled');
    });
  }

  function updateTimer() {
    if (!appState.eStopActive) {
      appState.timerSeconds++;
      updateTimerDisplay();
    }
  }
  
  function updateTimerDisplay() {
    const hours = Math.floor(appState.timerSeconds / 3600);
    const minutes = Math.floor((appState.timerSeconds % 3600) / 60);
    const secs = appState.timerSeconds % 60;
    
    const timerElement = document.querySelector('.timer');
    timerElement.textContent = 
      `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  // Update status
  function updateStatus(newStatus) {
    appState.status = newStatus;
    const statusText = document.querySelector('.status-text');
    
    statusText.classList.remove('status-standby', 'status-dispensing', 'status-calibrating', 
                               'status-dropping', 'status-done', 'status-offline');
    statusText.classList.add(`status-${newStatus}`);
    statusText.textContent = newStatus.toUpperCase();
  }

  // Emergency stop function
  function emergencyStop() {
    appState.eStopActive = true;
    appState.isDispensing = false;
    
    if (appState.timerInterval) {
      clearInterval(appState.timerInterval);
      appState.timerInterval = null;
    }
    
    // Close all servos
    const servoPosCells = document.querySelectorAll('.servo-pos');
    servoPosCells.forEach(cell => {
      cell.textContent = '0%';
    });
    
    // Update status
    updateStatus('offline');
    
    // Re-enable mixers
    const mixers = document.querySelectorAll('.mixer:not(.offline)');
    mixers.forEach(mixer => {
      mixer.classList.remove('disabled');
    });
    
    logEvent('EMERGENCY STOP ACTIVATED');
    closeModal('emergency-modal');
  }

  // Maintenance request functions
  function updateMaintenanceForm() {
    const department = document.getElementById('department').value;
    const issueTypeGroup = document.getElementById('issue-type-group');
    const issueTypeSelect = document.getElementById('issue-type');
    
    // Clear previous options
    issueTypeSelect.innerHTML = '<option value="">Select Issue Type</option>';
    
    if (department) {
      issueTypeGroup.style.display = 'block';
      
      // Add options based on department
      let options = [];
      
      switch(department) {
        case 'admin':
          options = ['REPORT PREVIOUS PRODUCTION'];
          break;
        case 'automation':
          options = ['SHUTTER SENSORS', 'LEVEL SENSORS ISSUE', 'SIGNAL ISSUE'];
          break;
        case 'electrical':
          options = ['PNUEMATIC CYLINDER LEAK', 'MANUAL BUTTONS ISSUE', 'WIRING CHECKUP'];
          break;
        case 'mechanical':
          options = ['CHAIN ISSUE', 'BELT ISSUE', 'SHUTTER ISSUE'];
          break;
      }
      
      options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        issueTypeSelect.appendChild(opt);
      });
    } else {
      issueTypeGroup.style.display = 'none';
    }
    
    updateRequestSentence();
  }

  function toggleBinSelection() {
    const binRelated = document.getElementById('bin-related').checked;
    const binSelectionGroup = document.getElementById('bin-selection-group');
    const binNumberSelect = document.getElementById('bin-number');
    
    if (binRelated) {
      binSelectionGroup.style.display = 'block';
      
      // Populate bin numbers if not already done
      if (binNumberSelect.options.length <= 1) {
        for (let i = 1; i <= 22; i++) {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = i;
          binNumberSelect.appendChild(opt);
        }
      }
    } else {
      binSelectionGroup.style.display = 'none';
    }
    
    updateRequestSentence();
  }

  function updateRequestSentence() {
    const department = document.getElementById('department').value;
    const issueType = document.getElementById('issue-type').value;
    const binRelated = document.getElementById('bin-related').checked;
    const binNumber = document.getElementById('bin-number').value;
    
    let sentence = "Please select department and issue type to generate request.";
    
    if (department && issueType) {
      sentence = `Requesting ${department} department for ${issueType.toLowerCase()}`;
      
      if (binRelated && binNumber) {
        sentence += ` related to Bin ${binNumber}`;
      }
      
      sentence += ".";
    }
    
    document.getElementById('request-sentence').textContent = sentence;
  }

  function submitMaintenanceRequest() {
    const department = document.getElementById('department').value;
    const issueType = document.getElementById('issue-type').value;
    
    if (!department || !issueType) {
      alert('Please select both department and issue type.');
      return;
    }
    
    const confirmSend = confirm('Are you sure you want to send this maintenance request?');
    if (confirmSend) {
      const binRelated = document.getElementById('bin-related').checked;
      const binNumber = document.getElementById('bin-number').value;
      
      let requestDetails = `Department: ${department}, Issue: ${issueType}`;
      if (binRelated && binNumber) {
        requestDetails += `, Bin: ${binNumber}`;
      }
      
      logEvent(`Maintenance request submitted: ${requestDetails}`);
      alert('Maintenance request submitted successfully.');
      
      // Reset form
      document.getElementById('department').value = '';
      document.getElementById('issue-type-group').style.display = 'none';
      document.getElementById('bin-related').checked = false;
      document.getElementById('bin-selection-group').style.display = 'none';
      document.getElementById('request-sentence').textContent = 'Please select department and issue type to generate request.';
      
      closeModal('maintenance-modal');
    }
  }

  // Theme functions
  function setTheme(theme) {
    // Remove all theme classes
    document.body.classList.remove('theme-light', 'theme-traditional', 'theme-soft');
    
    // Add selected theme class
    if (theme !== 'dark') {
      document.body.classList.add(`theme-${theme}`);
    }
    
    // Update active theme option
    document.querySelectorAll('.theme-option').forEach(option => {
      option.classList.remove('active');
    });
    document.querySelector(`.theme-${theme}`).classList.add('active');
    
    appState.currentTheme = theme;
  }

  // Log event
  function logEvent(message) {
    const timestamp = new Date().toLocaleTimeString();
    console.log(`[${timestamp}] ${message}`);
  }

  // Modal functionality
  function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
  }
  
  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
  }
  
  // Close modal when clicking outside
  window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
      event.target.classList.remove('active');
    }
  }
  
  // Refresh data function
  function refreshData() {
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
      card.style.transform = 'scale(0.98)';
      setTimeout(() => {
        card.style.transform = '';
      }, 300);
    });
    
    const originalText = document.querySelector('.header .box:nth-child(2)').textContent;
    document.querySelector('.header .box:nth-child(2)').textContent = 'REFRESHING DATA...';
    
    setTimeout(() => {
      document.querySelector('.header .box:nth-child(2)').textContent = originalText;
    }, 1000);
    
    logEvent('Dashboard data refreshed');
  }

  // Initialize the app when the page loads
  window.onload = initializeApp;
</script>

</body>
</html>